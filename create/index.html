<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyApp Feed - Main</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* Base styles */
        body {
            font-family: 'Lato', sans-serif; 
            min-height: 100vh;
            background-color: #f4f7f6;
        }
        /* Modal Overlay must be on top of everything */
        .modal-overlay { z-index: 1000; }
        /* Style for image in feed to ensure good display */
        .post-image {
            max-height: 400px;
            object-fit: cover;
            width: 100%;
        }
        
        /* Style for the fixed profile sidebar on desktop (Max Height & Sticky) */
        @media (min-width: 768px) {
            #profile-sidebar, #following-list-sidebar {
                /* Fix top position relative to header height + some margin */
                top: 6rem; 
                /* Max height to be the viewport height minus header/footer margin */
                height: calc(100vh - 8rem); 
                overflow-y: auto; /* Allow scrolling */
            }
        }
    </style>
</head>
<body class="text-gray-900">

    <header class="bg-white shadow-md sticky top-0 z-10">
        <div class="max-w-4xl mx-auto flex items-center justify-between p-4">
            <h1 class="text-2xl font-extrabold text-blue-600">MyApp Feed</h1>
            
            <div class="flex items-center space-x-4">
                
                <div id="auth-controls" class="flex items-center space-x-4">
                    
                    <button id="logout-btn"
                            class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition hidden">
                        Log Out
                    </button>

                    <a href="../index.html" id="login-link"
                            class="px-3 py-1 text-sm bg-blue-100 text-blue-600 font-medium rounded-lg hover:bg-blue-200 transition hidden">
                        Log In
                    </a>
                </div>

                <button id="create-post-btn"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition duration-150 ease-in-out flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                    Create Post
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4 flex flex-col md:flex-row gap-6">
        
        <div class="w-full md:w-1/3 flex flex-col gap-6">
            
            <aside id="profile-sidebar" class="w-full hidden md:sticky md:block md:self-start">
                <div class="bg-white p-6 rounded-xl shadow-xl border border-blue-100">
                    <h3 class="text-xl font-extrabold text-blue-800 mb-4 border-b pb-2">Your Profile</h3>
                    
                    <div class="flex flex-col items-center mb-4">
                        <div id="profile-avatar" class="h-16 w-16 bg-blue-500 rounded-full flex items-center justify-center text-3xl font-bold text-white shadow-lg mb-3">
                            </div>
                        <p id="profile-display-name" class="text-xl font-bold text-gray-800 break-words text-center"></p>
                        <p id="profile-display-email" class="text-sm text-gray-500 break-words text-center"></p>
                    </div>
                    
                    <a href="#" class="w-full mt-4 flex justify-center py-2 text-sm text-blue-600 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 transition">
                        View Full Profile (Demo)
                    </a>
                </div>
            </aside>
            
            <aside id="following-list-sidebar" class="w-full hidden md:block md:self-start">
                <div class="bg-white p-6 rounded-xl shadow-xl border border-gray-100">
                    <h3 class="text-xl font-extrabold text-gray-700 mb-4 border-b pb-2">Following</h3>
                    <div id="following-list" class="space-y-3">
                        <p class="text-gray-500 text-sm italic">Follow users to see them here.</p>
                    </div>
                </div>
            </aside>
            
        </div>


        <div class="w-full md:w-2/3">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Latest Posts</h2>
            
            <div id="feed-container" class="space-y-6">
            </div>
        </div>
    </main>

    <div id="post-modal" class="modal-overlay hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-8 shadow-2xl max-w-lg w-full">
            <h3 class="text-2xl font-bold mb-5 text-gray-800">Create a New Post</h3>
            
            <form id="new-post-form" class="space-y-4">
                
                <div>
                    <label for="post-text" class="block text-sm font-medium text-gray-700 mb-1">
                        What's on your mind?
                    </label>
                    <textarea id="post-text" rows="4" maxlength="500" required
                        class="appearance-none block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm 
                        placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-base"
                        placeholder="Enter your message (max 500 characters)"></textarea>
                </div>

                <div>
                    <label for="post-image-url" class="block text-sm font-medium text-gray-700 mb-1">
                        Image URL (Optional)
                    </label>
                    <input id="post-image-url" type="url" 
                        class="appearance-none block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm 
                        placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-base"
                        placeholder="Paste an image link here (e.g., from Unsplash)">
                    <p class="mt-2 text-xs text-gray-500">
                        *Note: We are using a URL input to simulate image upload for this static HTML/JS demo.
                    </p>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancel-post-btn"
                            class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                        Cancel
                    </button>
                    <button type="submit" id="submit-post-btn"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition">
                        Post to Feed
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="logout-modal" class="modal-overlay hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-8 shadow-2xl max-w-sm w-full space-y-4">
            <h3 class="text-xl font-bold text-gray-800">Confirm Logout</h3>
            <p class="text-gray-700">Are you sure you want to log out of MyApp?</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" type="button" class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                    Cancel
                </button>
                <button id="modal-logout-confirm-btn" type="button" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                    Log Out
                </button>
            </div>
        </div>
    </div>
    
    <div id="message-box" class="fixed bottom-4 right-4 p-3 bg-green-500 text-white rounded-lg shadow-xl hidden transition-opacity duration-300">
        </div>


    <script>
        // DOM Elements
        const logoutBtn = document.getElementById('logout-btn');
        const loginLink = document.getElementById('login-link');
        const profileSidebar = document.getElementById('profile-sidebar');
        const profileAvatar = document.getElementById('profile-avatar');
        const profileDisplayName = document.getElementById('profile-display-name');
        const profileDisplayEmail = document.getElementById('profile-display-email');
        // NEW: Following list element
        const followingList = document.getElementById('following-list');
        
        // Modal elements
        const logoutModal = document.getElementById('logout-modal');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalLogoutConfirmBtn = document.getElementById('modal-logout-confirm-btn');
        const messageBox = document.getElementById('message-box');

        let currentUser = null;

        // --- Helper Functions ---
        function showMessage(message, duration = 3000, isError = false) {
            messageBox.innerText = message;
            // Set background color based on message type
            messageBox.classList.remove('bg-green-500', 'bg-red-500');
            messageBox.classList.add(isError ? 'bg-red-500' : 'bg-green-500');

            messageBox.classList.remove('hidden', 'opacity-0');
            messageBox.classList.add('opacity-100');
            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 300);
            }, duration);
        }
        
        // --- User Data Management (Handles the new 'following' array) ---
        function loadCurrentUser() {
            try {
                const userString = localStorage.getItem('currentUser');
                if (userString) {
                    let user = JSON.parse(userString);
                    // Ensure 'following' array exists
                    user.following = user.following || []; 
                    return user;
                }
                return null;
            } catch (e) {
                console.error("Error loading current user:", e);
                return null;
            }
        }

        function saveCurrentUser(user) {
            try {
                // IMPORTANT: Use loadCurrentUser to ensure we save the entire user object including 'following'
                let savedUser = loadCurrentUser(); 
                if (savedUser) {
                    // Only update the 'following' list and other critical properties
                    savedUser.following = user.following;
                    localStorage.setItem('currentUser', JSON.stringify(savedUser));
                    currentUser = savedUser; // Update the global variable
                } else {
                     // If for some reason the full user isn't there, save the provided one
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    currentUser = user;
                }
            } catch (e) {
                console.error("Error saving current user:", e);
            }
        }


        // --- Authentication Check ---
        function checkAuthentication() {
            currentUser = loadCurrentUser();
            
            if (currentUser) {
                const name = currentUser.name || currentUser.email.split('@')[0];
                const initials = name.charAt(0).toUpperCase();

                // Logged In State: Show profile and Log Out button
                logoutBtn.classList.remove('hidden');
                loginLink.classList.add('hidden');
                profileSidebar.classList.remove('hidden');
                
                // Populate Profile Sidebar
                profileAvatar.innerText = initials;
                profileDisplayName.innerText = name;
                profileDisplayEmail.innerText = currentUser.email || 'No email available';

            } else {
                // Logged Out State: Hide profile and Log Out button, show Log In link
                currentUser = null;
                logoutBtn.classList.add('hidden');
                loginLink.classList.remove('hidden');
                profileSidebar.classList.add('hidden');
                
                // Redirect is crucial for a real app, but for local demo, we use a friendly redirect
                window.location.href = "../index.html"; 
            }
        }

        // --- Log Out Handler (Unchanged) ---
        logoutBtn.addEventListener('click', () => {
            logoutModal.classList.remove('hidden');
        });
        
        modalCancelBtn.addEventListener('click', () => {
            logoutModal.classList.add('hidden');
        });
        
        modalLogoutConfirmBtn.addEventListener('click', () => {
            localStorage.removeItem('currentUser');
            logoutModal.classList.add('hidden');
            showMessage("You have been logged out.", 1500);
            setTimeout(() => {
                window.location.href = "../index.html"; 
            }, 1800);
        });

        // --- Post Management and Feed Logic ---

        const postModal = document.getElementById('post-modal');
        const createPostBtn = document.getElementById('create-post-btn');
        const cancelPostBtn = document.getElementById('cancel-post-btn');
        const newPostForm = document.getElementById('new-post-form');
        const feedContainer = document.getElementById('feed-container');

        function loadPosts() {
            try {
                const posts = localStorage.getItem('appPosts');
                if (posts) {
                    return JSON.parse(posts);
                } else {
                    return [{
                        id: 0,
                        userId: 'system',
                        userName: 'MyApp Admin',
                        text: "Welcome to your social feed! Click the 'Create Post' button to share your first image and message.",
                        imageUrl: 'https://placehold.co/600x200/4f46e5/ffffff?text=Welcome+Image',
                        timestamp: new Date().toISOString(),
                        likes: [] 
                    }];
                }
            } catch (e) {
                console.error("Error loading posts:", e);
                return [];
            }
        }

        function savePosts(posts) {
            try {
                localStorage.setItem('appPosts', JSON.stringify(posts));
            } catch (e) {
                console.error("Error saving posts:", e);
                showMessage("Could not save post data.", 3000, true);
            }
        }
        
        function renderPost(post) {
            const avatarInitial = post.userName ? post.userName.charAt(0).toUpperCase() : 'U';
            const postAuthorEmail = post.userId;
            const isMyPost = currentUser && postAuthorEmail === currentUser.email;

            const imageHtml = post.imageUrl
                ? `<div class="mb-4"><img src="${post.imageUrl}" alt="Post Image" class="post-image rounded-lg" onerror="this.onerror=null;this.src='https://placehold.co/600x200/cccccc/333333?text=Image+Load+Failed'"></div>`
                : '';
            
            // --- Like Logic ---
            const isLiked = currentUser && post.likes && post.likes.includes(currentUser.email);
            const likeButtonClasses = isLiked ? 'text-red-600 bg-red-100 hover:bg-red-200' : 'text-gray-600 bg-gray-100 hover:bg-gray-200';
            const likeIcon = isLiked ? 
                `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" /></svg>` :
                `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>`;
            
            // --- Delete Logic ---
            const isDeletable = isMyPost;
            const deleteButtonHtml = isDeletable ? `
                <button data-post-id="${post.id}" class="delete-post-btn px-3 py-1 text-sm bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Delete
                </button>
            ` : '';

            // --- Follow Logic (Re-implemented) ---
            const isFollowing = currentUser && currentUser.following.includes(postAuthorEmail);
            const followButtonText = isFollowing ? 'Unfollow' : 'Follow';
            const followButtonClasses = isFollowing ? 'text-gray-600 bg-gray-200 hover:bg-gray-300' : 'text-blue-600 bg-blue-100 hover:bg-blue-200';
            const followButtonHtml = !isMyPost && postAuthorEmail !== 'system' ? `
                <button data-user-email="${postAuthorEmail}" data-user-name="${post.userName}"
                        class="follow-post-btn ml-3 px-3 py-1 text-xs font-semibold rounded-full transition ${followButtonClasses}">
                    ${followButtonText}
                </button>
            ` : '';
            
            const postHtml = `
                <div class="bg-white p-6 rounded-xl shadow-xl border border-gray-100" data-post-id="${post.id}">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-start">
                            <div class="h-10 w-10 bg-blue-100 rounded-full mr-3 flex items-center justify-center text-lg font-bold text-blue-600 shadow-inner">
                                ${avatarInitial}
                            </div>
                            <div>
                                <p class="font-bold text-lg text-gray-800">${post.userName || 'Unknown User'}</p>
                                <p class="text-xs text-gray-500">${new Date(post.timestamp).toLocaleString()}</p>
                            </div>
                        </div>
                        ${followButtonHtml}
                    </div>
                    ${imageHtml}
                    <p class="text-gray-700 whitespace-pre-wrap mb-4">${post.text}</p>

                    <div class="flex justify-between items-center border-t pt-3">
                        <div class="flex items-center space-x-4">
                            <button data-post-id="${post.id}" class="like-post-btn px-3 py-1 text-sm rounded-lg transition flex items-center ${likeButtonClasses}">
                                ${likeIcon}
                                <span>${post.likes ? post.likes.length : 0} Like${(post.likes && post.likes.length !== 1) ? 's' : ''}</span>
                            </button>
                            ${deleteButtonHtml}
                        </div>
                        <p class="text-sm text-gray-500 hidden sm:block">Post ID: ${post.id}</p>
                    </div>
                </div>
            `;
            feedContainer.insertAdjacentHTML('afterbegin', postHtml);
        }

        // NEW: Function to render the list of followed users
        function renderFollowingSidebar() {
            // Ensure currentUser is loaded and has a following array
            if (!currentUser || !currentUser.following || currentUser.following.length === 0) {
                followingList.innerHTML = '<p class="text-gray-500 text-sm italic">Follow users to see them here.</p>';
                return;
            }

            followingList.innerHTML = ''; // Clear previous list

            currentUser.following.forEach(followedEmail => {
                const displayEmail = followedEmail.split('@')[0];
                const initial = displayEmail.charAt(0).toUpperCase();

                const itemHtml = `
                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                        <div class="flex items-center">
                            <div class="h-8 w-8 bg-purple-100 rounded-full mr-3 flex items-center justify-center text-sm font-bold text-purple-600">
                                ${initial}
                            </div>
                            <p class="text-sm font-medium text-gray-700 truncate">${displayEmail}</p>
                        </div>
                        <button data-user-email="${followedEmail}" data-user-name="${displayEmail}"
                                class="follow-post-btn text-xs font-medium text-red-500 hover:text-red-700" 
                                title="Unfollow ${displayEmail}">
                            Unfollow
                        </button>
                    </div>
                `;
                followingList.insertAdjacentHTML('beforeend', itemHtml);
            });
            // Show the sidebar container if there are items, otherwise, the parent element might hide it based on layout
            document.getElementById('following-list-sidebar').classList.remove('hidden');
        }


        function refreshFeed() {
            feedContainer.innerHTML = ''; 
            
            const posts = loadPosts();
            posts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            posts.forEach(post => renderPost(post));
            
            // NEW: Render the following list
            renderFollowingSidebar();

            // Re-attach delegated event listeners after refreshing the feed
            attachFeedEventListeners();
        }
        
        // --- Core Action Logic ---

        function toggleLike(postId) {
            if (!currentUser) {
                showMessage("You must be logged in to like a post.", 3000, true);
                return;
            }

            let posts = loadPosts();
            const postIndex = posts.findIndex(p => p.id == postId);

            if (postIndex === -1) return;

            const post = posts[postIndex];
            post.likes = post.likes || [];
            const userEmail = currentUser.email;

            if (post.likes.includes(userEmail)) {
                // Unlike
                post.likes = post.likes.filter(email => email !== userEmail);
                showMessage("Unliked post.", 1500);
            } else {
                // Like
                post.likes.push(userEmail);
                showMessage("Liked post!", 1500);
            }

            savePosts(posts);
            refreshFeed(); 
        }

        function deletePost(postId) {
            if (!currentUser) {
                showMessage("You must be logged in to delete a post.", 3000, true);
                return;
            }

            let posts = loadPosts();
            const postIndex = posts.findIndex(p => p.id == postId);

            if (postIndex === -1) return;

            const post = posts[postIndex];
            
            // Security check: Only owner can delete
            if (post.userId !== currentUser.email) {
                showMessage("You can only delete your own posts.", 3000, true);
                return;
            }

            if (confirm("Are you sure you want to delete this post?")) {
                posts.splice(postIndex, 1);
                savePosts(posts);
                refreshFeed();
                showMessage("Post deleted.", 1500);
            }
        }
        
        // NEW: Function to handle following/unfollowing
        function toggleFollow(followedEmail, followedUserName) {
            if (!currentUser) {
                showMessage("You must be logged in to follow users.", 3000, true);
                return;
            }

            if (followedEmail === currentUser.email) {
                showMessage("You cannot follow yourself.", 3000, true);
                return;
            }
            
            currentUser = loadCurrentUser(); // Ensure we have the latest data
            const isFollowing = currentUser.following.includes(followedEmail);
            
            if (isFollowing) {
                // Unfollow
                currentUser.following = currentUser.following.filter(email => email !== followedEmail);
                showMessage(`You unfollowed ${followedUserName}.`, 1500);
            } else {
                // Follow
                currentUser.following.push(followedEmail);
                showMessage(`You are now following ${followedUserName}!`, 1500);
            }

            saveCurrentUser(currentUser);
            refreshFeed(); // Refresh to update button states and sidebar
        }


        // --- Event Delegation for Feed (Updated to include Follow button) ---
        function attachFeedEventListeners() {
            // Remove previous listener to avoid duplicates
            feedContainer.removeEventListener('click', handleFeedClick); 
            feedContainer.addEventListener('click', handleFeedClick);
            
            // Also attach listener to the following sidebar for unfollow actions
            followingList.removeEventListener('click', handleFeedClick); 
            followingList.addEventListener('click', handleFeedClick);
        }

        function handleFeedClick(e) {
            // Check for Like Button click
            const likeBtn = e.target.closest('.like-post-btn');
            if (likeBtn) {
                e.preventDefault();
                const postId = likeBtn.dataset.postId;
                toggleLike(postId);
                return;
            }

            // Check for Delete Button click
            const deleteBtn = e.target.closest('.delete-post-btn');
            if (deleteBtn) {
                e.preventDefault();
                const postId = deleteBtn.dataset.postId;
                deletePost(postId);
                return;
            }
            
            // Check for Follow/Unfollow Button click
            const followBtn = e.target.closest('.follow-post-btn');
            if (followBtn) {
                e.preventDefault();
                const followedEmail = followBtn.dataset.userEmail;
                const followedUserName = followBtn.dataset.userName || followedEmail.split('@')[0];
                toggleFollow(followedEmail, followedUserName);
                return;
            }
        }

        // --- Event Listeners (Post Modal) (Unchanged) ---

        createPostBtn.addEventListener('click', () => {
            if (!currentUser) {
                showMessage("Please log in to create a post.", 3000, true);
                return;
            }
            postModal.classList.remove('hidden');
        });

        cancelPostBtn.addEventListener('click', () => {
            postModal.classList.add('hidden');
            newPostForm.reset();
        });

        newPostForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const text = document.getElementById('post-text').value.trim();
            const imageUrl = document.getElementById('post-image-url').value.trim();

            if (!text) {
                showMessage("Please enter some text for your post.", 3000, true);
                return;
            }
            
            const posts = loadPosts().filter(post => post.id !== 0); 

            const newPost = {
                id: Date.now(),
                userId: currentUser.email,
                userName: currentUser.name || currentUser.email,
                text: text,
                imageUrl: imageUrl,
                timestamp: new Date().toISOString(),
                likes: []
            };

            posts.push(newPost);
            savePosts(posts);

            postModal.classList.add('hidden');
            newPostForm.reset();
            refreshFeed(); 
            showMessage("Post created successfully!", 2000);
        });

        // Initialize Authentication and Feed when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            checkAuthentication();
            refreshFeed();
        });
    </script>
</body>
</html>